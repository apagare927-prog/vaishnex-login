<script>
/* ===============================
   Dynamic welcome (no repeat)
================================ */
const lines = [
  "Secure login powered by Vaishnex",
  "Fast • Secure • Reliable",
  "Your identity, protected",
  "Smart access starts here",
  "One account. Many possibilities."
];

let last = localStorage.getItem("vx_line");
let idx;
do {
  idx = Math.floor(Math.random() * lines.length);
} while (idx == last);

localStorage.setItem("vx_line", idx);
document.getElementById("dynamic").innerText = lines[idx];

/* ===============================
   Elements
================================ */
const loginInput = document.getElementById("loginInput");
const phoneWrap  = document.getElementById("phoneWrap");
const phoneInput = document.getElementById("phoneInput");
const error      = document.getElementById("error");

const otpBox   = document.getElementById("otpBox");
const otpInput = document.getElementById("otpInput");
const otpError = document.getElementById("otpError");

const sendBtn   = document.getElementById("sendBtn");
const resendBtn = document.getElementById("resendBtn");
const timerBox  = document.getElementById("timer");

let iti = null;
let timer = null;

/* ===============================
   Input detect (email / number)
================================ */
loginInput.addEventListener("input", () => {
  clearError();
  const v = loginInput.value.trim();

  if (v === "") {
    hidePhone();
    return;
  }

  // EMAIL
  if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)) {
    hidePhone();
    error.innerText = "Email detected";
    return;
  }

  // NUMBER
  if (/^[0-9+ ]+$/.test(v)) {
    showPhone(v);
  } else {
    hidePhone();
  }
});

/* ===============================
   Show phone selector
   (IP-based auto country)
================================ */
function showPhone(value) {
  phoneWrap.classList.remove("hidden");

  if (!iti) {
    iti = intlTelInput(phoneInput, {
      separateDialCode: true,
      nationalMode: true,
      initialCountry: "auto",

      geoIpLookup: function (cb) {
        fetch("https://ipwho.is/?fields=country_code")
          .then(res => res.json())
          .then(data => {
            if (data && data.country_code) {
              cb(data.country_code.toLowerCase());
            } else {
              cb("in"); // fallback
            }
          })
          .catch(() => cb("in"));
      },

      utilsScript:
        "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"
    });
  }

  phoneInput.value = value;
}

function hidePhone() {
  phoneWrap.classList.add("hidden");
}

/* ===============================
   Send OTP (UI logic)
================================ */
sendBtn.onclick = () => {
  clearError();
  clearOtpError();

  const v = loginInput.value.trim();

  if (v === "") {
    showError("Field cannot be empty");
    return;
  }

  if (v.includes("@")) {
    showError("OTP not required for email");
    return;
  }

  if (!iti || !iti.isValidNumber()) {
    showError("Invalid mobile number");
    return;
  }

  otpBox.classList.remove("hidden");
  startTimer();
};

/* ===============================
   OTP validation (UI)
================================ */
otpInput.addEventListener("input", () => {
  clearOtpError();

  if (otpInput.value.length > 0 && otpInput.value.length < 4) {
    showOtpError("OTP too short");
  }
});

/* ===============================
   30s Timer + Resend
================================ */
function startTimer() {
  let t = 30;
  resendBtn.classList.add("hidden");
  timerBox.classList.remove("hidden");
  timerBox.innerText = `Resend OTP in ${t}s`;

  clearInterval(timer);
  timer = setInterval(() => {
    t--;
    timerBox.innerText = `Resend OTP in ${t}s`;

    if (t <= 0) {
      clearInterval(timer);
      timerBox.classList.add("hidden");
      resendBtn.classList.remove("hidden");
    }
  }, 1000);
}

resendBtn.onclick = () => sendBtn.click();

/* ===============================
   Error helpers
================================ */
function showError(msg) {
  loginInput.classList.add("error");
  error.innerText = msg;
}

function clearError() {
  loginInput.classList.remove("error");
  error.innerText = "";
}

function showOtpError(msg) {
  otpInput.classList.add("error");
  otpError.innerText = msg;
}

function clearOtpError() {
  otpInput.classList.remove("error");
  otpError.innerText = "";
}
</script>
